# Fastfile for CopiChat

default_platform(:ios)

platform :ios do
  # å¤‰æ•°å®šç¾©
  SCHEME = "copichat"
  WORKSPACE = "copichat.xcodeproj"

  # å…±é€šã®å‰å‡¦ç†
  before_all do
    # Xcodeã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
    ensure_xcode_version
  end

  # TestFlightã«ãƒ“ãƒ«ãƒ‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  desc "TestFlightã«ãƒ“ãƒ«ãƒ‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
  lane :beta do
    # ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    increment_build_number(
      xcodeproj: WORKSPACE
    )

    # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆ
    build_app(
      scheme: SCHEME,
      export_method: "app-store",
      output_directory: "./build",
      output_name: "CopiChat.ipa"
    )

    # TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )

    UI.success("âœ… TestFlightã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼")
  end

  # App Storeã«å¯©æŸ»æå‡º
  desc "App Storeã«å¯©æŸ»æå‡º"
  lane :release do
    # ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹ã‹ç¢ºèª
    version = UI.input("æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç¾åœ¨: #{get_version_number(xcodeproj: WORKSPACE)}ï¼‰:")

    if version && !version.empty?
      increment_version_number(
        version_number: version,
        xcodeproj: WORKSPACE
      )
    end

    # ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    increment_build_number(
      xcodeproj: WORKSPACE
    )

    # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆ
    build_app(
      scheme: SCHEME,
      export_method: "app-store",
      output_directory: "./build",
      output_name: "CopiChat.ipa"
    )

    # App Store Connectã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: true,
      automatic_release: false,
      submission_information: {
        add_id_info_uses_idfa: false
      }
    )

    UI.success("ğŸš€ App Storeã¸ã®å¯©æŸ»æå‡ºãŒå®Œäº†ã—ã¾ã—ãŸï¼")
  end

  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
  desc "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ"
  lane :bump_version do
    version = increment_version_number(
      bump_type: "patch", # major, minor, patch
      xcodeproj: WORKSPACE
    )

    increment_build_number(
      xcodeproj: WORKSPACE
    )

    UI.success("âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ #{version} ã«æ›´æ–°ã—ã¾ã—ãŸ")
  end

  # ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰
  desc "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ³"
  lane :clean do
    clean_build_artifacts
    clear_derived_data
    UI.success("ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³å®Œäº†")
  end

  # ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
  error do |lane, exception|
    UI.error("âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: #{exception.message}")
  end
end
