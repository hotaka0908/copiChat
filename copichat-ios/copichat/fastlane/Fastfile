# Fastfile for CopiChat

default_platform(:ios)

platform :ios do
  # å¤‰æ•°å®šç¾©
  SCHEME = "copichat"
  WORKSPACE = "copichat.xcodeproj"

  # å…±é€šã®å‰å‡¦ç†
  before_all do
    # Xcodeã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªï¼ˆå¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
    # ensure_xcode_version(version: "16.0")
  end

  # TestFlightã«ãƒ“ãƒ«ãƒ‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  desc "TestFlightã«ãƒ“ãƒ«ãƒ‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
  lane :beta do
    # App Store Connect APIèªè¨¼
    app_store_connect_api_key(
      key_id: "JMG6DSKMT5",
      issuer_id: "11f290de-18c4-4721-9813-228137cc6ae8",
      key_filepath: "./fastlane/AuthKey_JMG6DSKMT5.p8"
    )

    # ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    increment_build_number(
      xcodeproj: WORKSPACE
    )

    # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆ
    build_app(
      scheme: SCHEME,
      export_method: "app-store",
      output_directory: "./build",
      output_name: "CopiChat.ipa",
      export_options: {
        method: "app-store",
        teamID: "J99PJ8SUF2",
        signingStyle: "automatic",
        uploadBitcode: false,
        uploadSymbols: true
      }
    )

    # TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )

    UI.success("âœ… TestFlightã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼")
  end

  # App Storeã«å¯©æŸ»æå‡º
  desc "App Storeã«å¯©æŸ»æå‡º"
  lane :release do
    # App Store Connect APIèªè¨¼
    app_store_connect_api_key(
      key_id: "JMG6DSKMT5",
      issuer_id: "11f290de-18c4-4721-9813-228137cc6ae8",
      key_filepath: "./fastlane/AuthKey_JMG6DSKMT5.p8"
    )

    # ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°ï¼ˆç’°å¢ƒå¤‰æ•°VERSION_NUMBERã§æŒ‡å®šå¯èƒ½ï¼‰
    version = ENV["VERSION_NUMBER"]

    if version && !version.empty?
      increment_version_number(
        version_number: version,
        xcodeproj: WORKSPACE
      )
      UI.success("âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ #{version} ã«æ›´æ–°ã—ã¾ã—ãŸ")
    else
      UI.message("â„¹ï¸  ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆ#{get_version_number(xcodeproj: WORKSPACE)}ï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™")
    end

    # ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’è‡ªå‹•ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    increment_build_number(
      xcodeproj: WORKSPACE
    )

    # ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
    sigh(
      app_identifier: "com.universalpine.copichat",
      adhoc: false,
      readonly: false,
      filename: "CopiChat_App_Store.mobileprovision"
    )

    # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆ
    build_app(
      scheme: SCHEME,
      export_method: "app-store",
      output_directory: "./build",
      output_name: "CopiChat.ipa",
      export_options: {
        method: "app-store",
        teamID: "J99PJ8SUF2",
        signingStyle: "automatic",
        uploadBitcode: false,
        uploadSymbols: true
      }
    )

    # App Store Connectã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false,  # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ã¿ã€‚App Store Connectã‹ã‚‰æ‰‹å‹•ã§å¯©æŸ»æå‡º
      automatic_release: false,
      force: true  # æ—¢å­˜ã®ãƒ“ãƒ«ãƒ‰ã‚’ä¸Šæ›¸ã
    )

    UI.success("âœ… App Store Connectã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼")
    UI.success("ğŸ“± App Store Connect (https://appstoreconnect.apple.com) ã‹ã‚‰å¯©æŸ»ã«æå‡ºã—ã¦ãã ã•ã„")
  end

  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
  desc "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ"
  lane :bump_version do
    version = increment_version_number(
      bump_type: "patch", # major, minor, patch
      xcodeproj: WORKSPACE
    )

    increment_build_number(
      xcodeproj: WORKSPACE
    )

    UI.success("âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ #{version} ã«æ›´æ–°ã—ã¾ã—ãŸ")
  end

  # ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰
  desc "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ³"
  lane :clean do
    clean_build_artifacts
    clear_derived_data
    UI.success("ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³å®Œäº†")
  end

  # ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
  error do |lane, exception|
    UI.error("âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: #{exception.message}")
  end
end
